# ç¬¬åä¸ƒç«  ADCåº”ç”¨è¡¥å……-å†…éƒ¨æ¸©åº¦ä¸Žå…‰æ•

## 1. å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨

### 1.1 å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨ç®€ä»‹

STM32F407 æœ‰ä¸€ä¸ªå†…éƒ¨çš„æ¸©åº¦ä¼ æ„Ÿå™¨ï¼Œå¯ä»¥ç”¨æ¥æµ‹é‡ CPU åŠå‘¨å›´çš„æ¸©åº¦(TA)ã€‚ å¯¹äºŽSTM32F407 ç³»åˆ—æ¥è¯´ï¼Œ è¯¥æ¸©åº¦ä¼ æ„Ÿå™¨åœ¨å†…éƒ¨å’Œ ADC1_INP16ï¼ˆ STM32F40xx/F41xx ç³»åˆ—ï¼‰æˆ–ADC_IN18ï¼ˆSTM32F42xx/F43xxï¼‰ è¾“å…¥é€šé“ç›¸è¿žæŽ¥ï¼Œæ­¤é€šé“æŠŠä¼ æ„Ÿå™¨è¾“å‡ºçš„ç”µåŽ‹è½¬æ¢æˆæ•°å­—å€¼ã€‚STM32F4 çš„å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨æ”¯æŒçš„æ¸©åº¦èŒƒå›´ä¸ºï¼š -40~125 åº¦ã€‚ç²¾åº¦ä¸ºÂ±1.5â„ƒå·¦å³ã€‚

STM32F407 å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œåªè¦è®¾ç½®ä¸€ä¸‹å†…éƒ¨ ADCï¼Œå¹¶æ¿€æ´»å…¶å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨é€šé“å°±å·®ä¸å¤šäº†ã€‚å…³äºŽ ADC çš„è®¾ç½®ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« å·²ç»è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†å¤šè¯´ã€‚æŽ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹å’Œæ¸©åº¦ä¼ æ„Ÿå™¨è®¾ç½®ç›¸å…³çš„ä¸¤ä¸ªåœ°æ–¹ã€‚

ç¬¬ä¸€ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨ STM32F407 çš„å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨ï¼Œå¿…é¡»å…ˆæ¿€æ´» ADC çš„å†…éƒ¨é€šé“ï¼Œè¿™é‡Œé€šè¿‡ ADC_CCR çš„ VSENSEEN ä½ï¼ˆbit23ï¼‰è®¾ç½®ã€‚è®¾ç½®è¯¥ä½ä¸º 1 åˆ™å¯ç”¨å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨ã€‚

ç¬¬äºŒä¸ªåœ°æ–¹ï¼Œ STM32F407ZGT6 çš„å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨å›ºå®šçš„è¿žæŽ¥åœ¨ ADC1 çš„é€šé“ 16 ä¸Šï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è®¾ç½®å¥½ ADC1 ä¹‹åŽåªè¦è¯»å–é€šé“ 16 çš„å€¼ï¼Œå°±æ˜¯æ¸©åº¦ä¼ æ„Ÿå™¨è¿”å›žæ¥çš„ç”µåŽ‹å€¼äº†ã€‚æ ¹æ®è¿™ä¸ªå€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºå½“å‰æ¸©åº¦ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

```c
ð‘‡(â„ƒ) ={(Vsense - V25) / Avg_Slope}+25
```

å¼å­ä¸­ï¼š

V25 = Vsense åœ¨ 25 åº¦æ—¶çš„æ•°å€¼ï¼ˆå…¸åž‹å€¼ä¸ºï¼š 0.76ï¼‰

Avg_Slope = æ¸©åº¦ä¸Ž Vsense æ›²çº¿çš„å¹³å‡æ–œçŽ‡ï¼ˆå•ä½ï¼š mv/â„ƒæˆ– uv/â„ƒï¼‰ï¼ˆå…¸åž‹å€¼ï¼š 2.5mv/â„ƒï¼‰ã€‚åˆ©ç”¨ä»¥ä¸Šå…¬å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–¹ä¾¿çš„è®¡ç®—å‡ºå½“å‰æ¸©åº¦ä¼ æ„Ÿå™¨çš„æ¸©åº¦äº†ã€‚

### 1.2 è½¯ä»¶è®¾è®¡

#### 1.2.1 å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨åˆå§‹åŒ–

```c
// å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨åˆå§‹åŒ–
void adc_temp_init(void)
{
    adc_init();
    ADC->CCR |= 1<<23;
}
```

#### 1.2.2 èŽ·å–å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨æ¸©åº¦å€¼

```c
// èŽ·å–å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨æ¸©åº¦å€¼
short adc_get_temp(void)
{
    uint32_t adc_val = 0;
    short result = 0;
    double temp;
    adc_val = adc_get_result_average(ADC_CHANNEL_TEMPSENSOR, 10);
    temp = (float)adc_val*(3.3/4095);
    temp = (temp - 0.76)/0.0025+25;
    temp *= 100;
    result = temp;
    return result;
}
```

#### 1.2.3 ä¸»å‡½æ•°æµ‹è¯•

```c
#include "bsp_init.h"
#include "stdio.h"
#include "adc.h"

int main(void)
{
  short temp;
  bsp_init();
  adc_temp_init();
  LCD_ShowString(30,50,200,16,16,"STM32F4 ADC Temperature");
  LCD_ShowString(30,120,200,16,16, "TEMPERATE: 00.00C");
    while(1)
  {
    temp = adc_get_temp();
    if(temp < 0)
    {
      temp = -temp;
      LCD_ShowString(110,120,16,16,16,"-");
    }
    else
    {
      LCD_ShowString(110,120,16,16,16," ");
    }
    LCD_ShowxNum(118,120,temp/100,2,16,0);
    LCD_ShowxNum(142,120,temp%100,2,16,0x80);
    LED_TOGGLE(LED0_GPIO_Pin);
    delay_ms(100);
  }
}
```

## 2. å…‰æ•ä¼ æ„Ÿå™¨

### 2.1 å…‰æ•ä¼ æ„Ÿå™¨ç®€ä»‹

å…‰æ•ä¼ æ„Ÿå™¨æ˜¯æœ€å¸¸è§çš„ä¼ æ„Ÿå™¨ä¹‹ä¸€ï¼Œå®ƒçš„ç§ç±»ç¹å¤šï¼Œä¸»è¦æœ‰ï¼šå…‰ç”µç®¡ã€å…‰ç”µå€å¢žç®¡ã€å…‰æ•ç”µé˜»ã€å…‰æ•ä¸‰æžç®¡ã€å¤ªé˜³èƒ½ç”µæ± ã€çº¢å¤–çº¿ä¼ æ„Ÿå™¨ã€ç´«å¤–çº¿ä¼ æ„Ÿå™¨ã€å…‰çº¤å¼å…‰ç”µä¼ æ„Ÿå™¨ã€è‰²å½©ä¼ æ„Ÿå™¨ã€ CCD å’Œ CMOS å›¾åƒä¼ æ„Ÿå™¨ç­‰ã€‚å…‰ä¼ æ„Ÿå™¨æ˜¯ç›®å‰äº§é‡æœ€å¤šã€åº”ç”¨æœ€å¹¿çš„ä¼ æ„Ÿå™¨ä¹‹ä¸€ï¼Œå®ƒåœ¨è‡ªåŠ¨æŽ§åˆ¶å’Œéžç”µé‡ç”µæµ‹æŠ€æœ¯ä¸­å æœ‰éžå¸¸é‡è¦çš„åœ°ä½ã€‚

å…‰æ•ä¼ æ„Ÿå™¨æ˜¯åˆ©ç”¨å…‰æ•å…ƒä»¶å°†å…‰ä¿¡å·è½¬æ¢ä¸ºç”µä¿¡å·çš„ä¼ æ„Ÿå™¨ï¼Œå®ƒçš„æ•æ„Ÿæ³¢é•¿åœ¨å¯è§å…‰æ³¢é•¿é™„è¿‘ï¼ŒåŒ…æ‹¬çº¢å¤–çº¿æ³¢é•¿å’Œç´«å¤–çº¿æ³¢é•¿ã€‚å…‰ä¼ æ„Ÿå™¨ä¸åªå±€é™äºŽå¯¹å…‰çš„æŽ¢æµ‹ï¼Œå®ƒè¿˜å¯ä»¥ä½œä¸ºæŽ¢æµ‹å…ƒä»¶ç»„æˆå…¶ä»–ä¼ æ„Ÿå™¨ï¼Œå¯¹è®¸å¤šéžç”µé‡è¿›è¡Œæ£€æµ‹ï¼Œåªè¦å°†è¿™äº›éžç”µé‡è½¬æ¢ä¸ºå…‰ä¿¡å·çš„å˜åŒ–å³å¯ã€‚

æŽ¢ç´¢è€… STM32F407 å¼€å‘æ¿æ¿è½½äº†ä¸€ä¸ªå…‰æ•äºŒæžç®¡ï¼ˆå…‰æ•ç”µé˜»ï¼‰ï¼Œä½œä¸ºå…‰æ•ä¼ æ„Ÿå™¨ï¼Œ å®ƒå¯¹å…‰çš„å˜åŒ–éžå¸¸æ•æ„Ÿã€‚ å…‰æ•äºŒæžç®¡ä¹Ÿå«å…‰ç”µäºŒæžç®¡ã€‚å…‰æ•äºŒæžç®¡ä¸ŽåŠå¯¼ä½“äºŒæžç®¡åœ¨ç»“æž„ä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œå…¶ç®¡èŠ¯æ˜¯ä¸€ä¸ªå…·æœ‰å…‰æ•ç‰¹å¾çš„ PN ç»“ï¼Œå…·æœ‰å•å‘å¯¼ç”µæ€§ï¼Œå› æ­¤å·¥ä½œæ—¶éœ€åŠ ä¸Šåå‘ç”µåŽ‹ã€‚æ— å…‰ç…§æ—¶ï¼Œæœ‰å¾ˆå°çš„é¥±å’Œåå‘æ¼ç”µæµï¼Œå³æš—ç”µæµï¼Œæ­¤æ—¶å…‰æ•äºŒæžç®¡æˆªæ­¢ã€‚å½“å—åˆ°å…‰ç…§æ—¶ï¼Œ é¥±å’Œåå‘æ¼ç”µæµå¤§å¤§å¢žåŠ ï¼Œå½¢æˆå…‰ç”µæµ,å®ƒéšå…¥å°„å…‰å¼ºåº¦çš„å˜åŒ–è€Œå˜åŒ–ã€‚å½“å…‰çº¿ç…§å°„ PN ç»“æ—¶ï¼Œå¯ä»¥ä½¿ PNç»“ä¸­äº§ç”Ÿç”µå­ä¸€ç©ºç©´å¯¹ï¼Œä½¿å°‘æ•°è½½æµå­çš„å¯†åº¦å¢žåŠ ã€‚è¿™äº›è½½æµå­åœ¨åå‘ç”µåŽ‹ä¸‹æ¼‚ç§»ï¼Œä½¿åå‘ç”µæµå¢žåŠ ã€‚å› æ­¤å¯ä»¥åˆ©ç”¨å…‰ç…§å¼ºå¼±æ¥æ”¹å˜ç”µè·¯ä¸­çš„ç”µæµã€‚

åˆ©ç”¨è¿™ä¸ªç”µæµå˜åŒ–ï¼Œæˆ‘ä»¬ä¸²æŽ¥ä¸€ä¸ªç”µé˜»ï¼Œå°±å¯ä»¥è½¬æ¢æˆç”µåŽ‹çš„å˜åŒ–ï¼Œä»Žè€Œé€šè¿‡ ADC è¯»å–ç”µåŽ‹å€¼ï¼Œåˆ¤æ–­å¤–éƒ¨å…‰çº¿çš„å¼ºå¼±ã€‚

æœ¬ç« ï¼Œæˆ‘ä»¬åˆ©ç”¨ ADC3 çš„é€šé“ 5ï¼ˆPF7ï¼‰æ¥è¯»å–å…‰æ•äºŒæžç®¡ç”µåŽ‹çš„å˜åŒ–ï¼Œä»Žè€Œå¾—åˆ°çŽ¯å¢ƒå…‰çº¿çš„å˜åŒ–ï¼Œå¹¶å°†å¾—åˆ°çš„å…‰çº¿å¼ºåº¦ï¼Œæ˜¾ç¤ºåœ¨ TFTLCD ä¸Šé¢ã€‚å…³äºŽ ADC çš„ä»‹ç»ï¼Œå‰é¢å·²ç»æœ‰è¯¦ç»†ä»‹ç»äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å†ç»†è¯´äº†ã€‚

![å±å¹•æˆªå›¾ 2025-08-10 124549.png](https://raw.githubusercontent.com/hazy1k/My-drawing-bed/main/2025/08/10-12-48-17-å±å¹•æˆªå›¾%202025-08-10%20124549.png)

### 2.2 è½¯ä»¶è®¾è®¡

#### 2.2.1 å…‰æ•ä¼ æ„Ÿå™¨åˆå§‹åŒ–

```c
// åˆå§‹åŒ–å…‰æ•ä¼ æ„Ÿå™¨-PF7
void light_sensor_init(void)
{
    GPIO_InitTypeDef gpio_init_structure;
    __HAL_RCC_GPIOF_CLK_ENABLE();
    gpio_init_structure.Pin = GPIO_PIN_7;
    gpio_init_structure.Mode = GPIO_MODE_ANALOG;
    gpio_init_structure.Pull = GPIO_NOPULL;
    HAL_GPIO_Init(GPIOF, &gpio_init_structure);
    adc_init();
}
```

#### 2.2.2 è¯»å–å…‰æ•ä¼ æ„Ÿå™¨å€¼

```c
// è¯»å–å…‰æ•ä¼ æ„Ÿå™¨å€¼
uint8_t light_sensor_read(void)
{
    uint32_t temp_val = 0;
    temp_val = adc_get_result_average(ADC_CHANNEL_5, 10);
    temp_val /= 40;
    if(temp_val > 100)
    {
        temp_val = 100;
    }
    return (uint8_t)(100-temp_val);
}

```

#### 2.2.3 ä¸»å‡½æ•°æµ‹è¯•

```c
#include "bsp_init.h"
#include "stdio.h"
#include "adc.h"

int main(void)
{
  uint16_t temp;
  bsp_init();
  light_sensor_init();
  LCD_ShowString(30,50,200,16,16,"LIGHT SENSOR TEST");
  LCD_ShowString(30,110,200,16,16, "LIGHT_VAL:");
	while(1)
  {
    temp = light_sensor_read();
    LCD_ShowxNum(110,110,temp,3,16,0);
    LED_TOGGLE(LED0_GPIO_Pin);
    delay_ms(100);
  }
}

```

---
